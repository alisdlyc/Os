     1                                  ; naskfunc
     2                                  ; TAB=4
     3                                  
     4                                  ;[FORMAT "WCOFF"]				; オブジェクトファイルを作るモード	
     5                                  ;[INSTRSET "i486p"]				; 486の命令まで使いたいという記述
     6                                  CPU 486
     7                                  [BITS 32]						; 32ビットモード用の機械語を作らせる
     8                                  ;[FILE "naskfunc.nas"]			; ソースファイル名情報
     9                                  
    10                                  		GLOBAL	io_hlt, io_cli, io_sti, io_stihlt
    11                                  		GLOBAL	io_in8,  io_in16,  io_in32
    12                                  		GLOBAL	io_out8, io_out16, io_out32
    13                                  		GLOBAL	io_load_eflags, io_store_eflags
    14                                  		GLOBAL	load_gdtr, load_idtr
    15                                  		GLOBAL	load_cr0, store_cr0
    16                                  		GLOBAL	load_tr
    17                                  		GLOBAL	asm_inthandler20, asm_inthandler21
    18                                  		GLOBAL	asm_inthandler2c, asm_inthandler0c
    19                                  		GLOBAL	asm_inthandler0d, asm_end_app
    20                                  		GLOBAL	memtest_sub
    21                                  		GLOBAL	farjmp, farcall
    22                                  		GLOBAL	asm_hrb_api, start_app
    23                                  		EXTERN	inthandler20, inthandler21
    24                                  		EXTERN	inthandler2c, inthandler0d
    25                                  		EXTERN	inthandler0c
    26                                  		EXTERN	hrb_api
    27                                  
    28                                  [SECTION .text]
    29                                  
    30                                  io_hlt:	; void io_hlt(void);
    31 00000000 F4                      		HLT
    32 00000001 C3                      		RET
    33                                  
    34                                  io_cli:	; void io_cli(void);
    35 00000002 FA                      		CLI
    36 00000003 C3                      		RET
    37                                  
    38                                  io_sti:	; void io_sti(void);
    39 00000004 FB                      		STI
    40 00000005 C3                      		RET
    41                                  
    42                                  io_stihlt:	; void io_stihlt(void);
    43 00000006 FB                      		STI
    44 00000007 F4                      		HLT
    45 00000008 C3                      		RET
    46                                  
    47                                  io_in8:	; int io_in8(int port);
    48 00000009 8B542404                		MOV		EDX,[ESP+4]		; port
    49 0000000D B800000000              		MOV		EAX,0
    50 00000012 EC                      		IN		AL,DX
    51 00000013 C3                      		RET
    52                                  
    53                                  io_in16:	; int io_in16(int port);
    54 00000014 8B542404                		MOV		EDX,[ESP+4]		; port
    55 00000018 B800000000              		MOV		EAX,0
    56 0000001D 66ED                    		IN		AX,DX
    57 0000001F C3                      		RET
    58                                  
    59                                  io_in32:	; int io_in32(int port);
    60 00000020 8B542404                		MOV		EDX,[ESP+4]		; port
    61 00000024 ED                      		IN		EAX,DX
    62 00000025 C3                      		RET
    63                                  
    64                                  io_out8:	; void io_out8(int port, int data);
    65 00000026 8B542404                		MOV		EDX,[ESP+4]		; port
    66 0000002A 8A442408                		MOV		AL,[ESP+8]		; data
    67 0000002E EE                      		OUT		DX,AL
    68 0000002F C3                      		RET
    69                                  
    70                                  io_out16:	; void io_out16(int port, int data);
    71 00000030 8B542404                		MOV		EDX,[ESP+4]		; port
    72 00000034 8B442408                		MOV		EAX,[ESP+8]		; data
    73 00000038 66EF                    		OUT		DX,AX
    74 0000003A C3                      		RET
    75                                  
    76                                  io_out32:	; void io_out32(int port, int data);
    77 0000003B 8B542404                		MOV		EDX,[ESP+4]		; port
    78 0000003F 8B442408                		MOV		EAX,[ESP+8]		; data
    79 00000043 EF                      		OUT		DX,EAX
    80 00000044 C3                      		RET
    81                                  
    82                                  io_load_eflags:	; int io_load_eflags(void);
    83 00000045 9C                      		PUSHFD		; PUSH EFLAGS という意味
    84 00000046 58                      		POP		EAX
    85 00000047 C3                      		RET
    86                                  
    87                                  io_store_eflags:	; void io_store_eflags(int eflags);
    88 00000048 8B442404                		MOV		EAX,[ESP+4]
    89 0000004C 50                      		PUSH	EAX
    90 0000004D 9D                      		POPFD		; POP EFLAGS という意味
    91 0000004E C3                      		RET
    92                                  
    93                                  load_gdtr:		; void load_gdtr(int limit, int addr);
    94 0000004F 668B442404              		MOV		AX,[ESP+4]		; limit
    95 00000054 6689442406              		MOV		[ESP+6],AX
    96 00000059 0F01542406              		LGDT	[ESP+6]
    97 0000005E C3                      		RET
    98                                  
    99                                  load_idtr:		; void load_idtr(int limit, int addr);
   100 0000005F 668B442404              		MOV		AX,[ESP+4]		; limit
   101 00000064 6689442406              		MOV		[ESP+6],AX
   102 00000069 0F015C2406              		LIDT	[ESP+6]
   103 0000006E C3                      		RET
   104                                  
   105                                  load_cr0:		; int load_cr0(void);
   106 0000006F 0F20C0                  		MOV		EAX,CR0
   107 00000072 C3                      		RET
   108                                  
   109                                  store_cr0:		; void store_cr0(int cr0);
   110 00000073 8B442404                		MOV		EAX,[ESP+4]
   111 00000077 0F22C0                  		MOV		CR0,EAX
   112 0000007A C3                      		RET
   113                                  
   114                                  load_tr:		; void load_tr(int tr);
   115 0000007B 0F005C2404              		LTR		[ESP+4]			; tr
   116 00000080 C3                      		RET
   117                                  
   118                                  asm_inthandler20:
   119 00000081 06                      		PUSH	ES
   120 00000082 1E                      		PUSH	DS
   121 00000083 60                      		PUSHAD
   122 00000084 89E0                    		MOV		EAX,ESP
   123 00000086 50                      		PUSH	EAX
   124 00000087 668CD0                  		MOV		AX,SS
   125 0000008A 8ED8                    		MOV		DS,AX
   126 0000008C 8EC0                    		MOV		ES,AX
   127 0000008E E8(00000000)            		CALL	inthandler20
   128 00000093 58                      		POP		EAX
   129 00000094 61                      		POPAD
   130 00000095 1F                      		POP		DS
   131 00000096 07                      		POP		ES
   132 00000097 CF                      		IRETD
   133                                  
   134                                  asm_inthandler21:
   135 00000098 06                      		PUSH	ES
   136 00000099 1E                      		PUSH	DS
   137 0000009A 60                      		PUSHAD
   138 0000009B 89E0                    		MOV		EAX,ESP
   139 0000009D 50                      		PUSH	EAX
   140 0000009E 668CD0                  		MOV		AX,SS
   141 000000A1 8ED8                    		MOV		DS,AX
   142 000000A3 8EC0                    		MOV		ES,AX
   143 000000A5 E8(00000000)            		CALL	inthandler21
   144 000000AA 58                      		POP		EAX
   145 000000AB 61                      		POPAD
   146 000000AC 1F                      		POP		DS
   147 000000AD 07                      		POP		ES
   148 000000AE CF                      		IRETD
   149                                  
   150                                  asm_inthandler2c:
   151 000000AF 06                      		PUSH	ES
   152 000000B0 1E                      		PUSH	DS
   153 000000B1 60                      		PUSHAD
   154 000000B2 89E0                    		MOV		EAX,ESP
   155 000000B4 50                      		PUSH	EAX
   156 000000B5 668CD0                  		MOV		AX,SS
   157 000000B8 8ED8                    		MOV		DS,AX
   158 000000BA 8EC0                    		MOV		ES,AX
   159 000000BC E8(00000000)            		CALL	inthandler2c
   160 000000C1 58                      		POP		EAX
   161 000000C2 61                      		POPAD
   162 000000C3 1F                      		POP		DS
   163 000000C4 07                      		POP		ES
   164 000000C5 CF                      		IRETD
   165                                  
   166                                  asm_inthandler0c:
   167 000000C6 FB                      		STI
   168 000000C7 06                      		PUSH	ES
   169 000000C8 1E                      		PUSH	DS
   170 000000C9 60                      		PUSHAD
   171 000000CA 89E0                    		MOV		EAX,ESP
   172 000000CC 50                      		PUSH	EAX
   173 000000CD 668CD0                  		MOV		AX,SS
   174 000000D0 8ED8                    		MOV		DS,AX
   175 000000D2 8EC0                    		MOV		ES,AX
   176 000000D4 E8(00000000)            		CALL	inthandler0c
   177 000000D9 83F800                  		CMP		EAX,0
   178 000000DC 0F8591000000            		JNE		asm_end_app
   179 000000E2 58                      		POP		EAX
   180 000000E3 61                      		POPAD
   181 000000E4 1F                      		POP		DS
   182 000000E5 07                      		POP		ES
   183 000000E6 83C404                  		ADD		ESP,4			; INT 0x0c でも、これが必要
   184 000000E9 CF                      		IRETD
   185                                  
   186                                  asm_inthandler0d:
   187 000000EA FB                      		STI
   188 000000EB 06                      		PUSH	ES
   189 000000EC 1E                      		PUSH	DS
   190 000000ED 60                      		PUSHAD
   191 000000EE 89E0                    		MOV		EAX,ESP
   192 000000F0 50                      		PUSH	EAX
   193 000000F1 668CD0                  		MOV		AX,SS
   194 000000F4 8ED8                    		MOV		DS,AX
   195 000000F6 8EC0                    		MOV		ES,AX
   196 000000F8 E8(00000000)            		CALL	inthandler0d
   197 000000FD 83F800                  		CMP		EAX,0			; ここだけ違う
   198 00000100 7571                    		JNE		asm_end_app	; ここだけ違う
   199 00000102 58                      		POP		EAX
   200 00000103 61                      		POPAD
   201 00000104 1F                      		POP		DS
   202 00000105 07                      		POP		ES
   203 00000106 83C404                  		ADD		ESP,4			; INT 0x0d では、これが必要
   204 00000109 CF                      		IRETD
   205                                  
   206                                  memtest_sub:	; unsigned int memtest_sub(unsigned int start, unsigned int end)
   207 0000010A 57                      		PUSH	EDI						; （EBX, ESI, EDI も使いたいので）
   208 0000010B 56                      		PUSH	ESI
   209 0000010C 53                      		PUSH	EBX
   210 0000010D BE55AA55AA              		MOV		ESI,0xaa55aa55			; pat0 = 0xaa55aa55;
   211 00000112 BFAA55AA55              		MOV		EDI,0x55aa55aa			; pat1 = 0x55aa55aa;
   212 00000117 8B442410                		MOV		EAX,[ESP+12+4]			; i = start;
   213                                  mts_loop:
   214 0000011B 89C3                    		MOV		EBX,EAX
   215 0000011D 81C3FC0F0000            		ADD		EBX,0xffc				; p = i + 0xffc;
   216 00000123 8B13                    		MOV		EDX,[EBX]				; old = *p;
   217 00000125 8933                    		MOV		[EBX],ESI				; *p = pat0;
   218 00000127 8333FF                  		XOR		DWORD [EBX],0xffffffff	; *p ^= 0xffffffff;
   219 0000012A 3B3B                    		CMP		EDI,[EBX]				; if (*p != pat1) goto fin;
   220 0000012C 7518                    		JNE		mts_fin
   221 0000012E 8333FF                  		XOR		DWORD [EBX],0xffffffff	; *p ^= 0xffffffff;
   222 00000131 3B33                    		CMP		ESI,[EBX]				; if (*p != pat0) goto fin;
   223 00000133 7511                    		JNE		mts_fin
   224 00000135 8913                    		MOV		[EBX],EDX				; *p = old;
   225 00000137 0500100000              		ADD		EAX,0x1000				; i += 0x1000;
   226 0000013C 3B442414                		CMP		EAX,[ESP+12+8]			; if (i <= end) goto mts_loop;
   227 00000140 76D9                    		JBE		mts_loop
   228 00000142 5B                      		POP		EBX
   229 00000143 5E                      		POP		ESI
   230 00000144 5F                      		POP		EDI
   231 00000145 C3                      		RET
   232                                  mts_fin:
   233 00000146 8913                    		MOV		[EBX],EDX				; *p = old;
   234 00000148 5B                      		POP		EBX
   235 00000149 5E                      		POP		ESI
   236 0000014A 5F                      		POP		EDI
   237 0000014B C3                      		RET
   238                                  
   239                                  farjmp:		; void farjmp(int eip, int cs);
   240 0000014C FF6C2404                		JMP		FAR	[ESP+4]				; eip, cs
   241 00000150 C3                      		RET
   242                                  
   243                                  farcall:		; void farcall(int eip, int cs);
   244 00000151 FF5C2404                		CALL	FAR	[ESP+4]				; eip, cs
   245 00000155 C3                      		RET
   246                                  
   247                                  asm_hrb_api:
   248 00000156 FB                      		STI
   249 00000157 1E                      		PUSH	DS
   250 00000158 06                      		PUSH	ES
   251 00000159 60                      		PUSHAD		; 保存のためのPUSH
   252 0000015A 60                      		PUSHAD		; hrb_apiにわたすためのPUSH
   253 0000015B 668CD0                  		MOV		AX,SS
   254 0000015E 8ED8                    		MOV		DS,AX		; OS用のセグメントをDSとESにも入れる
   255 00000160 8EC0                    		MOV		ES,AX
   256 00000162 E8(00000000)            		CALL	hrb_api
   257 00000167 83F800                  		CMP		EAX,0		; EAXが0でなければアプリ終了処理
   258 0000016A 7507                    		JNE		asm_end_app
   259 0000016C 83C420                  		ADD		ESP,32
   260 0000016F 61                      		POPAD
   261 00000170 07                      		POP		ES
   262 00000171 1F                      		POP		DS
   263 00000172 CF                      		IRETD
   264                                  asm_end_app:
   265                                  ;	EAXはtss.esp0の番地
   266 00000173 8B20                    		MOV		ESP,[EAX]
   267 00000175 C7400400000000          		MOV		DWORD [EAX+4],0
   268 0000017C 61                      		POPAD
   269 0000017D C3                      		RET					; cmd_appへ帰る
   270                                  
   271                                  start_app:		; void start_app(int eip, int cs, int esp, int ds, int *tss_esp0);
   272 0000017E 60                      		PUSHAD		; 32ビットレジスタを全部保存しておく
   273 0000017F 8B442424                		MOV		EAX,[ESP+36]	; アプリ用のEIP
   274 00000183 8B4C2428                		MOV		ECX,[ESP+40]	; アプリ用のCS
   275 00000187 8B54242C                		MOV		EDX,[ESP+44]	; アプリ用のESP
   276 0000018B 8B5C2430                		MOV		EBX,[ESP+48]	; アプリ用のDS/SS
   277 0000018F 8B6C2434                		MOV		EBP,[ESP+52]	; tss.esp0の番地
   278 00000193 896500                  		MOV		[EBP  ],ESP		; OS用のESPを保存
   279 00000196 8C5504                  		MOV		[EBP+4],SS		; OS用のSSを保存
   280 00000199 8EC3                    		MOV		ES,BX
   281 0000019B 8EDB                    		MOV		DS,BX
   282 0000019D 8EE3                    		MOV		FS,BX
   283 0000019F 8EEB                    		MOV		GS,BX
   284                                  ;	以下はRETFでアプリに行かせるためのスタック調整
   285 000001A1 83C903                  		OR		ECX,3			; アプリ用のセグメント番号に3をORする
   286 000001A4 83CB03                  		OR		EBX,3			; アプリ用のセグメント番号に3をORする
   287 000001A7 53                      		PUSH	EBX				; アプリのSS
   288 000001A8 52                      		PUSH	EDX				; アプリのESP
   289 000001A9 51                      		PUSH	ECX				; アプリのCS
   290 000001AA 50                      		PUSH	EAX				; アプリのEIP
   291 000001AB CB                      		RETF
   292                                  ;	アプリが終了してもここには来ない
